- name: Upload APK to Google Drive
  id: upload_artifact
  env:
    GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
    GOOGLE_DRIVE_FOLDER_ID: ${{ steps.select_folder.outputs.folder_id }}
  run: |
    echo "$GOOGLE_DRIVE_CREDENTIALS" > credentials.json

    pip install --quiet google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

    python3 <<EOF > drive_output.txt
import os
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

SCOPES = ['https://www.googleapis.com/auth/drive.file']
APK_PATH = '${{ steps.find_apk.outputs.apk_path }}'
FOLDER_ID = os.environ.get('GOOGLE_DRIVE_FOLDER_ID')

credentials = service_account.Credentials.from_service_account_file(
    'credentials.json', scopes=SCOPES)
drive_service = build('drive', 'v3', credentials=credentials)

file_metadata = {'name': 'app-release.apk', 'parents': [FOLDER_ID]}
media = MediaFileUpload(APK_PATH, mimetype='application/vnd.android.package-archive')
uploaded_file = drive_service.files().create(
    body=file_metadata,
    media_body=media,
    fields='webViewLink, webContentLink'
).execute()

view_link = uploaded_file.get('webViewLink')
print(f"::notice::ðŸ”— Uploaded: {view_link}")
print(f"upload_url={view_link}")
EOF

    grep upload_url drive_output.txt >> $GITHUB_OUTPUT
