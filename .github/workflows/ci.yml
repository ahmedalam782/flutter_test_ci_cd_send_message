name: CI/CD Build APK and Upload to Drive and Send Link to Telegram Channel and Send to Gmail Account

on:
  push:
    branches:
      - main
      - test
  workflow_dispatch:

jobs:

  delete-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: kolpav/purge-artifacts-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          expire-in: 0days

  Get_Info:
    name: Get Info
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch_name.outputs.branch_name }}
      project_name: ${{ steps.project_name.outputs.project_name }}
      commit_author: ${{ steps.commit_author.outputs.commit_author }}
      commit_author_email: ${{ steps.commit_author_email.outputs.commit_author_email }}
      date_time: ${{ steps.date_time.outputs.date_time }}
      date_url: ${{ steps.date_url.outputs.date_url }}

    steps:
      - uses: actions/checkout@v2

      - id: branch_name
        run: echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - id: project_name
        run: echo "project_name=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT

      - id: commit_author
        run: echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - id: commit_author_email
        run: echo "commit_author_email=$(git log -1 --pretty=%ae)" >> $GITHUB_OUTPUT

      - id: date_time
        run: echo "date_time=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - id: date_url
        run: echo "date_url=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d')" >> $GITHUB_OUTPUT

  Build_Android_Apk:
    name: Build Android APK
    needs: [Get_Info, delete-artifacts]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Java
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.22.1
          channel: 'stable'

      - run: flutter clean
      - run: flutter pub get
      - run: flutter build apk --release --no-tree-shake-icons

  Upload_Apk:
    name: Upload APK
    needs: [Get_Info, delete-artifacts, Build_Android_Apk]
    runs-on: ubuntu-latest
    outputs:
      folder_id: ${{ steps.select_folder.outputs.folder_id }}
      upload_url: ${{ steps.upload_artifact.outputs.upload_url }}

    steps:
      - uses: actions/checkout@v2

      - id: select_folder
        run: |
          if [[ "${{ needs.Get_Info.outputs.branch_name }}" == "main" ]]; then
            echo "folder_id=${{ secrets.MAIN_FOLDER_ID }}" >> $GITHUB_OUTPUT
          else
            echo "folder_id=${{ secrets.TEST_FOLDER_ID }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Google Drive
        uses: adityak74/google-drive-upload-git-action@main
        with:
          credentials: "${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}"
          filename: "build/app/outputs/flutter-apk/app-release.apk"
          folderId: ${{ steps.select_folder.outputs.folder_id }}
          name: "${{ needs.Get_Info.outputs.branch_name }}_apk_${{ needs.Get_Info.outputs.date_time }}.apk"
          overwrite: "true"
          mimeType: "application/vnd.android.package-archive"

      - id: upload_artifact
        run: |
          url=$(curl --upload-file build/app/outputs/flutter-apk/app-release.apk https://transfer.sh/${{ needs.Get_Info.outputs.date_url }}-app-release.apk)
          echo "upload_url=${url}" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v2
        with:
          name: ${{ needs.Get_Info.outputs.branch_name }}-app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk

  Notify_User:
    name: Notify Users
    needs: [Get_Info, delete-artifacts, Build_Android_Apk, Upload_Apk]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Notify Telegram Channel
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸš€ *New APK Build Uploaded*

            ğŸ”” *Project:* `${{ needs.Get_Info.outputs.project_name }}`
            ğŸ¤– *Branch:* `${{ needs.Get_Info.outputs.branch_name }}`
            ğŸ‘¤ *Author:* `${{ needs.Get_Info.outputs.commit_author }}`
            ğŸ“© *Email:* `${{ needs.Get_Info.outputs.commit_author_email }}`
            ğŸ“… *Date:* `${{ needs.Get_Info.outputs.date_time }}`

            ğŸ”— [Google Drive Folder](https://drive.google.com/drive/folders/${{ needs.Upload_Apk.outputs.folder_id }})
            ğŸ”— [Transfer.sh Link](${{ needs.Upload_Apk.outputs.upload_url }})

      - name: Notify Gmail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          from: ${{ needs.Get_Info.outputs.commit_author_email }}
          to: mazenn770@gmail.com
          subject: "CI ğŸ‘‰ğŸ» New APK Build Uploaded"
          convert_markdown: true
          body: |
            Dear Sir,

            A new APK build has been uploaded.

            - Project: ${{ needs.Get_Info.outputs.project_name }}
            - Branch: ${{ needs.Get_Info.outputs.branch_name }}
            - Date: ${{ needs.Get_Info.outputs.date_time }}

            Download the APK:
            - ğŸ”— [Google Drive Folder](https://drive.google.com/drive/folders/${{ needs.Upload_Apk.outputs.folder_id }})
            - ğŸ”— [Transfer.sh Link](${{ needs.Upload_Apk.outputs.upload_url }})

            Best regards,  
            ${{ needs.Get_Info.outputs.commit_author }}  
            Flutter Developer  
            IX Solutions Company  
            Email: ${{ needs.Get_Info.outputs.commit_author_email }}
