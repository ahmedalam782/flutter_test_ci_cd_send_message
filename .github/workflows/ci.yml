name: CI/CD Build APK and Upload to Drive and Notify
on:
  push:
    branches:
      - main
      - test
  workflow_dispatch:

jobs:
  delete-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: kolpav/purge-artifacts-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          expire-in: 0days

  Get_Info:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch_name.outputs.branch_name }}
      project_name: ${{ steps.project_name.outputs.project_name }}
      commit_author: ${{ steps.commit_author.outputs.commit_author }}
      commit_author_email: ${{ steps.commit_author_email.outputs.commit_author_email }}
      date_time: ${{ steps.date_time.outputs.date_time }}
      date_url: ${{ steps.date_url.outputs.date_url }}
    steps:
      - uses: actions/checkout@v2
      - id: branch_name
        run: echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
      - id: project_name
        run: echo "project_name=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
      - id: commit_author
        run: echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
      - id: commit_author_email
        run: echo "commit_author_email=$(git log -1 --pretty=%ae)" >> $GITHUB_OUTPUT
      - id: date_time
        run: echo "date_time=$(git log -1 --pretty=%cd --date=format:'%B %d, %Y %I:%M %p')" >> $GITHUB_OUTPUT
      - id: date_url
        run: echo "date_url=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d')" >> $GITHUB_OUTPUT

  Build_And_Upload_APK:
    needs: [Get_Info, delete-artifacts]
    runs-on: ubuntu-latest
    outputs:
      folder_id: ${{ steps.select_folder.outputs.folder_id }}
      upload_url: ${{ steps.upload_artifact.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v2
      
      - uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          channel: stable
          
      - name: Build APK
        run: |
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons
          
      - name: Find and verify APK
        id: find_apk
        run: |
          echo "Searching for APK files..."
          find . -name "*.apk" -type f
          
          # Try common Flutter APK locations
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            apk_path="build/app/outputs/flutter-apk/app-release.apk"
          elif [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            apk_path="build/app/outputs/apk/release/app-release.apk"
          else
            # Fallback to finding any APK
            apk_path=$(find . -name "*release*.apk" -type f | head -n 1)
          fi
          
          if [ -z "$apk_path" ]; then
            echo "APK not found!"
            exit 1
          fi
          
          echo "Found APK at: $apk_path"
          echo "apk_path=$apk_path" >> $GITHUB_OUTPUT
          
      - name: Select folder and debug
        id: select_folder
        run: |
          echo "Branch name: ${{ needs.Get_Info.outputs.branch_name }}"
          echo "Main folder ID exists: ${{ secrets.MAIN_FOLDER_ID != '' }}"
          echo "Test folder ID exists: ${{ secrets.TEST_FOLDER_ID != '' }}"
          
          if [[ "${{ needs.Get_Info.outputs.branch_name }}" == "main" ]]; then
            if [[ -n "${{ secrets.MAIN_FOLDER_ID }}" ]]; then
              echo "folder_id=${{ secrets.MAIN_FOLDER_ID }}" >> $GITHUB_OUTPUT
              echo "Selected main folder: ${{ secrets.MAIN_FOLDER_ID }}"
            else
              echo "⚠️ MAIN_FOLDER_ID secret is not set!"
              echo "folder_id=" >> $GITHUB_OUTPUT
            fi
          else
            if [[ -n "${{ secrets.TEST_FOLDER_ID }}" ]]; then
              echo "folder_id=${{ secrets.TEST_FOLDER_ID }}" >> $GITHUB_OUTPUT
              echo "Selected test folder: ${{ secrets.TEST_FOLDER_ID }}"
            else
              echo "⚠️ TEST_FOLDER_ID secret is not set!"
              echo "folder_id=" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: Upload to Google Drive
        if: steps.select_folder.outputs.folder_id != '' && secrets.GOOGLE_DRIVE_CREDENTIALS != ''
        uses: adityak74/google-drive-upload-git-action@main
        with:
          credentials: "${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}"
          filename: "${{ steps.find_apk.outputs.apk_path }}"
          folderId: "${{ steps.select_folder.outputs.folder_id }}"
          name: "${{ needs.Get_Info.outputs.branch_name }}_apk_${{ needs.Get_Info.outputs.date_time }}.apk"
          overwrite: "true"
          mimeType: "application/vnd.android.package-archive"
          
      - name: Skip Google Drive upload
        if: steps.select_folder.outputs.folder_id == '' || secrets.GOOGLE_DRIVE_CREDENTIALS == ''
        run: |
          echo "⚠️ Skipping Google Drive upload"
          if [[ -z "${{ steps.select_folder.outputs.folder_id }}" ]]; then
            echo "- Missing folder ID (check MAIN_FOLDER_ID/TEST_FOLDER_ID secrets)"
          fi
          if [[ -z "${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}" ]]; then
            echo "- Missing Google Drive credentials (check GOOGLE_DRIVE_CREDENTIALS secret)"
          fi
          
      - id: upload_artifact
        run: |
          url=$(curl --upload-file "${{ steps.find_apk.outputs.apk_path }}" https://transfer.sh/${{ needs.Get_Info.outputs.date_url }}-app-release.apk)
          echo "upload_url=$url" >> $GITHUB_OUTPUT
          
      - name: Upload APK to GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: "${{ steps.find_apk.outputs.apk_path }}"
